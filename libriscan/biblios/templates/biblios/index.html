{% extends "biblios/base.html" %}
{% load static %}

{% block title %}All Documents - LibriScan{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold mb-6">All Documents</h1>

  {% if user.is_authenticated %}
    
    <!-- Banner: Continue Working (only shows if user has edited docs and not searching) -->
    {% if latest_doc and not current_search %}
    <div class="alert alert-info shadow-sm py-2 mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div class="flex-1">
        <span class="text-sm">
          Continue: Document #{{ latest_doc.id }} - {{ latest_doc.instance.identifier }}
          <span class="opacity-70">{{ latest_doc.history_date|timesince }} ago</span>
        </span>
      </div>
      <a href="{{ latest_doc.instance.get_absolute_url }}" class="btn btn-primary btn-xs">Open</a>
    </div>
    {% endif %}

    <!-- Toolbar: Search, View Toggle, Filter -->
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between mb-6">
      
      <!-- Search Input -->
      <div class="flex-1 w-full sm:w-auto">
        <input 
          type="text" 
          name="search" 
          value="{{ current_search }}"
          placeholder="Filter documents below..."
          class="input input-bordered input-sm w-full max-w-md"
          hx-get="{% url 'index' %}"
          hx-trigger="keyup changed delay:500ms"
          hx-target="#document-table-container"
          hx-include="[name='view'],[name='filter']">
      </div>

      <!-- View Toggle (List/Grid) -->
      <div class="join">
        <button class="join-item btn btn-sm {% if current_view == 'list' %}btn-active{% endif %}"
                hx-get="{% url 'index' %}?view=list&{{ keep_params }}"
                hx-target="#document-table-container">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          List
        </button>
        <button class="join-item btn btn-sm {% if current_view == 'grid' %}btn-active{% endif %}"
                hx-get="{% url 'index' %}?view=grid&{{ keep_params }}"
                hx-target="#document-table-container">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
          </svg>
          Grid
        </button>
      </div>

      <!-- Filter Dropdown -->
      <select name="filter" 
              class="select select-bordered select-sm"
              hx-get="{% url 'index' %}"
              hx-trigger="change"
              hx-target="#document-table-container"
              hx-include="[name='search'],[name='view']">
        <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All</option>
        <option value="collections" {% if current_filter == 'collections' %}selected{% endif %}>Collections</option>
        <option value="series" {% if current_filter == 'series' %}selected{% endif %}>Series</option>
        <option value="documents" {% if current_filter == 'documents' %}selected{% endif %}>Documents</option>
      </select>

    </div>

    <!-- Document Count -->
    <div class="text-sm text-base-content/70 mb-4">
      Showing {{ paginator.count }} document{{ paginator.count|pluralize }}
    </div>

    <!-- Table Container (HTMX target) -->
    <div id="document-table-container">
      
      {% if documents %}
        <!-- Table with daisyUI styling -->
        <div class="overflow-x-auto">
          <table class="table table-zebra table-sm">
            <thead>
              <tr>
                <th>
                  <a href="?sort=id&dir={% if current_sort == 'id' and current_dir == 'asc' %}desc{% else %}asc{% endif %}&{{ keep_params }}"
                     class="link link-hover">
                    ID {% if current_sort == 'id' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                  </a>
                </th>
                <th>
                  <a href="?sort=identifier&dir={% if current_sort == 'identifier' and current_dir == 'asc' %}desc{% else %}asc{% endif %}&{{ keep_params }}"
                     class="link link-hover">
                    Document Title {% if current_sort == 'identifier' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                  </a>
                </th>
                <th>
                  <a href="?sort=collection&dir={% if current_sort == 'collection' and current_dir == 'asc' %}desc{% else %}asc{% endif %}&{{ keep_params }}"
                     class="link link-hover">
                    Collection {% if current_sort == 'collection' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                  </a>
                </th>
                <th>
                  <a href="?sort=series&dir={% if current_sort == 'series' and current_dir == 'asc' %}desc{% else %}asc{% endif %}&{{ keep_params }}"
                     class="link link-hover">
                    Series {% if current_sort == 'series' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                  </a>
                </th>
                <th>
                  <a href="?sort=updated&dir={% if current_sort == 'updated' and current_dir == 'asc' %}desc{% else %}asc{% endif %}&{{ keep_params }}"
                     class="link link-hover">
                    Last Updated {% if current_sort == 'updated' %}{% if current_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}
                  </a>
                </th>
                <th>Updated By</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in documents %}
              <tr class="hover">
                <td>{{ doc.id }}</td>
                <td>
                  <a href="{{ doc.get_absolute_url }}" class="link link-primary">
                    {{ doc.identifier }}
                  </a>
                </td>
                <td>{{ doc.collection.name|default:"-" }}</td>
                <td>{{ doc.series.name|default:"-" }}</td>
                <td>
                  {% if doc._last_updated %}
                    {{ doc._last_updated|timesince }} ago
                  {% else %}
                    Never
                  {% endif %}
                </td>
                <td>
                  {% with doc.history.first as last_edit %}
                    {% if last_edit %}
                      {{ last_edit.history_user.email|default:"Unknown" }}
                    {% else %}
                      -
                    {% endif %}
                  {% endwith %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination with daisyUI join buttons -->
        {% if paginator.num_pages > 1 %}
        <div class="flex justify-center mt-6">
          <div class="join">
            
            <!-- Previous Button -->
            {% if page_obj.has_previous %}
              <a href="?page={{ page_obj.previous_page_number }}&{{ keep_params }}" 
                 class="join-item btn btn-sm">
                Previous
              </a>
            {% else %}
              <button class="join-item btn btn-sm btn-disabled" disabled>Previous</button>
            {% endif %}

            <!-- Page Numbers -->
            {% for num in page_obj.paginator.page_range %}
              {% if num == page_obj.number %}
                <button class="join-item btn btn-sm btn-active">{{ num }}</button>
              {% elif num == 1 or num == paginator.num_pages or num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                <a href="?page={{ num }}&{{ keep_params }}" class="join-item btn btn-sm">{{ num }}</a>
              {% elif num == page_obj.number|add:"-3" or num == page_obj.number|add:"3" %}
                <button class="join-item btn btn-sm btn-disabled" disabled>...</button>
              {% endif %}
            {% endfor %}

            <!-- Next Button -->
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}&{{ keep_params }}" 
                 class="join-item btn btn-sm">
                Next
              </a>
            {% else %}
              <button class="join-item btn btn-sm btn-disabled" disabled>Next</button>
            {% endif %}

          </div>
        </div>
        {% endif %}

      {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-base-content">No Documents Found</h3>
          <p class="mt-1 text-sm text-base-content/70">Try adjusting your search or filters</p>
        </div>
      {% endif %}

    </div>

  {% else %}
    <!-- Not Authenticated -->
    <div class="alert alert-warning">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>Please log in to view documents.</span>
    </div>
  {% endif %}

</div>
{% endblock %}