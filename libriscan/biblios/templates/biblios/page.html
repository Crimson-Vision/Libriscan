{% extends "biblios/base.html" %}
{% load static %}

{% block tutorial_section %}
<!-- Tutorials Section - Only on Page View -->
<li class="menu-title">
  <span class="flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
    </svg>
    Tutorials
  </span>
</li>
<li>
  <a id="startTutorial" class="active">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
    </svg>
    <div class="flex flex-col items-start">
      <span class="font-semibold">Page Walkthrough</span>
      <span class="text-xs opacity-70">Learn the basics</span>
    </div>
  </a>
</li>
<li>
  <a id="startKeyboardShortcuts">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
    </svg>
    <div class="flex flex-col items-start">
      <span class="font-semibold">Keyboard Shortcuts</span>
      <span class="text-xs opacity-70">Work faster with keys</span>
    </div>
  </a>
</li>
<li>
  <a id="startWordEditingTutorial">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
    </svg>
    <div class="flex flex-col items-start">
      <span class="font-semibold">Word Editing</span>
      <span class="text-xs opacity-70">Edit & manage words</span>
    </div>
  </a>
</li>
{% endblock %}

{% block tutorial_divider %}
<div class="divider my-1"></div>
{% endblock %}

{% block content %}
<nav class="mb-3 text-sm breadcrumbs">
  <ul>
    <li>
      <a href="{{ page.document.collection.owner.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-primary/10">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
          </svg>
        </span>
        {{ page.document.collection.owner }}
      </a>
    </li>
    <li>
      <a href="{{ page.document.collection.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-accent/10">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
        </span>
        {{ page.document.collection }}
      </a>
    </li>
    {% if page.document.series %}
    <li>
      <a href="{{ page.document.series.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-secondary/10">
          <svg xmlns="http://www.w3.org/2000/svg" class="size-4 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg>
        </span>
        {{ page.document.series }}
      </a>
    </li>
    {% endif %}
    <li>
      <a href="{{ page.document.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-warning/20">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 text-neutral">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
          </svg>
        </span>
        {{ page.document }}
      </a>
    </li>
    <li>
      <span class="flex items-center gap-1 text-base-content/60">
        <span class="inline-flex items-center justify-center size-5 rounded bg-info/20">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
          </svg>
        </span>
        Page {{ page.number }}
      </span>
    </li>
  </ul>
</nav>

<div class="container mx-auto h-full">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
    <!-- Left: Page Image & Actions -->
    <div class="flex flex-col items-center h-full w-full">
      <div class="card bg-base-100 shadow-sm w-full h-full">
        <div class="card-body p-4 h-full flex flex-col">
          <div class="mb-2 w-full">
            <!-- Page Navigation: full-width grid (prev / current / next) -->
            <div id="pageNavigation" class="grid grid-cols-3 gap-2 w-full">
              <!-- Previous Button -->
              <div>
                {% if prev_page %}
                <a href="{% url 'page' keys.owner keys.collection_slug keys.doc prev_page %}" class="btn btn-sm w-full" aria-label="Previous page">
                  <span aria-hidden="true">«</span>
                  <span class="hidden md:inline"> Previous</span>
                </a>
                {% else %}
                <button class="btn btn-sm btn-disabled w-full" aria-label="Previous page" disabled>
                  <span aria-hidden="true">«</span>
                  <span class="hidden md:inline"> Previous</span>
                </button>
                {% endif %}
              </div>

              <!-- Current Page Dropdown -->
              <div class="flex items-center justify-center">
                <div class="w-full">
                  <div class="dropdown dropdown-hover w-full">
                    <div tabindex="0" role="button" class="btn btn-sm w-full" aria-label="Select page">Page {{ page.number }}</div>
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow max-h-60 overflow-y-auto">
                      {% for page_num in all_pages %}
                        {% if page_num == page.number %}
                          <li><a class="active flex justify-between">
                            <span>Page {{ page_num }}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-3">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
                          </a></li>
                        {% else %}
                          <li><a href="{% url 'page' keys.owner keys.collection_slug keys.doc page_num %}">Page {{ page_num }}</a></li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Next Button -->
              <div>
                {% if next_page %}
                <a href="{% url 'page' keys.owner keys.collection_slug keys.doc next_page %}" class="btn btn-sm w-full" aria-label="Next page">
                  <span class="hidden md:inline">Next </span>
                  <span aria-hidden="true">»</span>
                </a>
                {% else %}
                <button class="btn btn-sm btn-disabled w-full" aria-label="Next page" disabled>
                  <span class="hidden md:inline">Next </span>
                  <span aria-hidden="true">»</span>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          <figure class="mb-4 flex justify-center">
            {% if page.image %}
              <!-- OpenSeadragon Viewer Container -->
              <div id="openseadragon-viewer" 
                   class="rounded-lg border border-base-300 w-full"
                   style="min-height:32rem; width:100%;"
                   data-image-url="{{ page.image.url }}">
              </div>
            {% else %}
              <div class="bg-base-200 rounded-lg h-96 w-full flex items-center justify-center text-base-content/60">No image available</div>
            {% endif %}
          </figure>
        </div>
      </div>
    </div>
  <!-- Right: Extracted Text -->
  <div id="rightColumn" class="h-full w-full">
      {% if page.words.exists %}
        {% include "biblios/components/forms/text_display.html" with words=page.words.all %}
      {% else %}
       <div id="extractPrompt" class="card bg-base-100 shadow-sm h-full">
        <div class="card-body flex flex-col justify-center items-center h-full text-center p-6">
          <h2 class="card-title text-2xl mb-4">No Text Extracted Yet</h2>
          <button
            hx-post="{% url 'page_extract' keys.owner keys.collection_slug keys.doc page.number %}"
            hx-target="#extractPrompt"
            hx-swap="outerHTML"
            class="btn btn-primary w-full"
            id="extractBtn"
            {% if page.has_extraction %}disabled{% endif %}>
            Extract
          </button>
          <p class="mb-4">Click <span class="font-bold">Extract</span> for intelligent extraction.</p>
        </div>  
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Page-specific JavaScript initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize OpenSeadragon viewer
    const viewer = document.getElementById('openseadragon-viewer');
    if (viewer && viewer.dataset.imageUrl) {
      initializeViewer(viewer.dataset.imageUrl);
    }
  });

  // HTMX Event Handlers
  document.addEventListener('htmx:beforeRequest', function(event) {
    // Disable Extract button during request
    if (event.target?.id === 'extractBtn') {
      event.target.disabled = true;
    }
  });

  document.addEventListener('htmx:afterSettle', function(event) {
    // Reinitialize components after HTMX content swaps
    
    // Check for word blocks and reinitialize handlers
    if (event.target.querySelector && event.target.querySelector('.word-block')) {
      console.log('HTMX content swap detected, reinitializing word handlers...');
      
      if (typeof WordSelector !== 'undefined') {
        new WordSelector();
      }
      
      if (typeof WordDetails !== 'undefined') {
        new WordDetails();
      }
    }
    
    // Reinitialize OpenSeadragon viewer after navigation
    const viewer = document.getElementById('openseadragon-viewer');
    if (viewer && viewer.dataset.imageUrl) {
      console.log('HTMX navigation detected, reinitializing viewer...');
      reinitializeViewer(viewer.dataset.imageUrl);
    }
  });

  document.addEventListener('htmx:beforeSwap', function(event) {
    // Clean up OpenSeadragon viewer to prevent memory leaks
    if (window.viewerInstance) {
      destroyViewer();
    }
  });
</script>
{% endblock %}