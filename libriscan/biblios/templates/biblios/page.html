{% extends "biblios/base.html" %}
{% load static %}
{% load icon_tags %}

{% block title %}{{page}} · {% if page.document.series %}{{ page.document.series }} · {% endif %}{{ page.document.collection }} · {{ page.document.collection.owner.short_name}} · Libriscan{% endblock %}

{% block tutorial_section %}
<!-- Tutorials Section - Only on Page View -->
<li class="menu-title">
  <span class="flex items-center gap-2">
    {% icon 'academic-cap' css_class='size-4' %}
    Tutorials
  </span>
</li>
<li>
  <a id="startTutorial" class="active">
    {% icon 'play' css_class='size-5' %}
    <div class="flex flex-col items-start">
      <span class="font-semibold">Page Walkthrough</span>
      <span class="text-xs opacity-70">Learn the basics</span>
    </div>
  </a>
</li>
<li>
  <a id="startKeyboardShortcuts">
    {% icon 'chat-bubble-left-right' css_class='size-5' %}
    <div class="flex flex-col items-start">
      <span class="font-semibold">Keyboard Shortcuts</span>
      <span class="text-xs opacity-70">Work faster with keys</span>
    </div>
  </a>
</li>
<li>
  <a id="startWordEditingTutorial">
    {% icon 'edit' css_class='size-5' %}
    <div class="flex flex-col items-start">
      <span class="font-semibold">Word Editing</span>
      <span class="text-xs opacity-70">Edit & manage words</span>
    </div>
  </a>
</li>
{% endblock %}

{% block tutorial_divider %}
<div class="divider my-1"></div>
{% endblock %}

{% block content %}
<nav id="page-breadcrumb" class="mb-3 text-sm breadcrumbs">
  <ul>
    <li>
      <a id="breadcrumb-org-link" href="{{ page.document.collection.owner.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-primary/10">
          {% icon 'building-library' css_class='size-4 text-primary' %}
        </span>
        {{ page.document.collection.owner }}
      </a>
    </li>
    <li>
      <a id="breadcrumb-collection-link" href="{{ page.document.collection.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-accent/10">
          {% icon 'bars' css_class='size-4 text-accent' stroke_width='2' %}
        </span>
        {{ page.document.collection }}
      </a>
    </li>
    {% if page.document.series %}
    <li>
      <a id="breadcrumb-series-link" href="{{ page.document.series.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-secondary/10">
          {% icon 'folder' css_class='size-4 text-secondary' stroke_width='2' %}
        </span>
        {{ page.document.series }}
      </a>
    </li>
    {% endif %}
    <li>
      <a id="breadcrumb-document-link" href="{{ page.document.get_absolute_url }}" class="flex items-center gap-1 hover:underline text-primary">
        <span class="inline-flex items-center justify-center size-5 rounded bg-warning/20">
          {% icon 'book' css_class='size-4 text-neutral' %}
        </span>
        {{ page.document }}
      </a>
    </li>
    <li>
      <span id="breadcrumb-page" class="flex items-center gap-1 text-base-content/60">
        <span class="inline-flex items-center justify-center size-5 rounded bg-info/20">
          {% icon 'document' css_class='size-4' %}
        </span>
        Page {{ page.number }}{% if page.identifier %} ({{ page.identifier }}){% else %} (Untitled){% endif %}
      </span>
    </li>
  </ul>
</nav>

<div id="page-view-container" class="container mx-auto h-full">
  <div id="page-view-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
    <!-- Left: Page Image & Actions -->
    <div id="page-image-container" class="flex flex-col items-center h-full w-full">
      <div id="page-image-card" class="card bg-base-100 shadow-sm w-full h-full">
        <div id="page-image-card-body" class="card-body p-4 h-full flex flex-col">
          <div id="page-navigation-wrapper" class="mb-2 w-full">
            <!-- Page Navigation: full-width grid (prev / current / next) -->
            <div id="pageNavigation" class="grid grid-cols-3 gap-2 w-full">
              <!-- Previous Button -->
              <div id="page-nav-prev">
                {% if prev_page %}
                <a id="page-prev-link" href="{% url 'page' keys.owner keys.collection_slug keys.doc prev_page %}" class="btn btn-sm w-full" aria-label="Previous page">
                  <span aria-hidden="true">«</span>
                  <span class="hidden md:inline"> Previous</span>
                </a>
                {% else %}
                <button id="page-prev-btn-disabled" class="btn btn-sm btn-disabled w-full" aria-label="Previous page" disabled>
                  <span aria-hidden="true">«</span>
                  <span class="hidden md:inline"> Previous</span>
                </button>
                {% endif %}
              </div>

              <!-- Current Page Dropdown -->
              <div id="page-nav-current" class="flex items-center justify-center">
                <div class="w-full">
                  <div id="page-dropdown" class="dropdown dropdown-hover w-full">
                    <div id="page-dropdown-button" tabindex="0" role="button" class="btn btn-sm w-full" aria-label="Select page">Page {{ page.number }}</div>
                    <ul id="page-dropdown-menu" tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow max-h-60 overflow-y-auto">
                      {% for page_num in all_pages %}
                        {% if page_num == page.number %}
                          <li><a id="page-menu-item-{{ page_num }}" class="active flex justify-between">
                            <span>Page {{ page_num }}</span>
                            {% icon 'check' css_class='size-3' %}
                          </a></li>
                        {% else %}
                          <li><a id="page-menu-item-{{ page_num }}" href="{% url 'page' keys.owner keys.collection_slug keys.doc page_num %}">Page {{ page_num }}</a></li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Next Button -->
              <div id="page-nav-next">
                {% if next_page %}
                <a id="page-next-link" href="{% url 'page' keys.owner keys.collection_slug keys.doc next_page %}" class="btn btn-sm w-full" aria-label="Next page">
                  <span class="hidden md:inline">Next </span>
                  <span aria-hidden="true">»</span>
                </a>
                {% else %}
                <button id="page-next-btn-disabled" class="btn btn-sm btn-disabled w-full" aria-label="Next page" disabled>
                  <span class="hidden md:inline">Next </span>
                  <span aria-hidden="true">»</span>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          <figure id="page-image-figure" class="mb-4 flex justify-center">
            {% if page.image %}
              <!-- OpenSeadragon Viewer Container -->
              <div id="openseadragon-viewer" 
                   class="rounded-lg border border-base-300 w-full"
                   style="min-height:32rem; width:100%;"
                   data-image-url="{{ page.image.url }}">
              </div>
            {% else %}
              <div id="page-no-image" class="bg-base-200 rounded-lg h-96 w-full flex items-center justify-center text-base-content/60">No image available</div>
            {% endif %}
          </figure>
        </div>
      </div>
    </div>
  <!-- Right: Extracted Text -->
  <div id="rightColumn" class="h-full w-full">
      {% if page.words.exists %}
        {% include "biblios/components/forms/text_display.html" with words=page.words.all %}
      {% elif extracting %}
        {% include "biblios/components/forms/extraction_loading.html" with short_name=keys.owner collection_slug=keys.collection_slug identifier=keys.doc number=page.number owner=page.document.collection.owner %}
      {% else %}
       <div id="extractPrompt" class="card bg-base-100 shadow-sm h-full">
        <div id="extract-prompt-body" class="card-body flex flex-col justify-center items-center h-full text-center p-6">
          <h2 id="extract-prompt-title" class="card-title text-2xl mb-4">No Text Extracted Yet</h2>
          <button
            hx-post="{% url 'page_extract' keys.owner keys.collection_slug keys.doc page.number %}"
            hx-target="#extractPrompt"
            hx-swap="outerHTML"
            class="btn btn-primary w-full"
            id="extractBtn"
            {% if not page.can_extract %}disabled{% endif %}>
            Extract
          </button>
          <p id="extract-prompt-message" class="mb-4 {% if not page.can_extract %}text-error{% endif %}">
            {% if page.can_extract %}
              Click <span class="font-bold">Extract</span> for intelligent extraction.
            {% else %}
              Text extraction is not available. The page may already have text blocks, or a cloud service may not be configured for this organization.
            {% endif %}
          </p>
        </div>  
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Page-specific JavaScript initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize OpenSeadragon viewer
    const viewer = document.getElementById('openseadragon-viewer');
    if (viewer && viewer.dataset.imageUrl) {
      initializeViewer(viewer.dataset.imageUrl);
    }
  });

  // HTMX Event Handlers
  document.addEventListener('htmx:beforeRequest', function(event) {
    // Disable Extract button during request
    if (event.target?.id === 'extractBtn') {
      event.target.disabled = true;
    }
  });

  document.addEventListener('htmx:afterSettle', function(event) {
    // Reinitialize components after HTMX content swaps
    
    // Reinitialize word handlers if swap contains word blocks
    const hasWordBlocks = event.target.querySelector?.('.word-block');
    if (hasWordBlocks) {
      if (window.wordDetailsInstance) window.wordDetailsInstance.destroy();
      if (typeof WordSelector !== 'undefined') new WordSelector();
      if (typeof WordDetails !== 'undefined') new WordDetails();
    } else if (typeof WordDetails !== 'undefined' && !window.wordDetailsInstance && document.querySelector('.word-block')) {
      // Recreate WordDetails if missing (e.g., after flag button swap)
      new WordDetails();
    }
    
    // Reinitialize OpenSeadragon viewer after navigation
    const viewer = document.getElementById('openseadragon-viewer');
    if (viewer && viewer.dataset.imageUrl) {
      console.log('HTMX navigation detected, reinitializing viewer...');
      reinitializeViewer(viewer.dataset.imageUrl);
    }
  });

  document.addEventListener('htmx:beforeSwap', function(event) {
    if (window.viewerInstance) destroyViewer();
    
    const target = event.detail.target;
    const isFlagSwap = target?.id === 'reviewFlagBtn' || target?.id?.includes('reviewFlag');
    const hasWordBlocks = !isFlagSwap && target && (
      target.querySelector?.('.word-block') || 
      target.classList?.contains('word-block') || 
      ['word-container', 'textDisplay'].includes(target.id)
    );
    
    if (hasWordBlocks && window.wordDetailsInstance) {
      window.wordDetailsInstance.destroy();
    }
  });
</script>
{% endblock %}