{% load django_htmx %}
{% load static %}
{% load icon_tags %}
<!doctype html>
<html lang="en-US" data-theme="light" id="html-root">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Libriscan{% endblock %}</title>

  <link rel="preload" href="{% static 'css/output.css' %}" as="style" crossorigin="anonymous">
  <!-- Preload critical JavaScript that loads in body for faster Time to Interactive -->
  <link rel="preload" href="{% static 'js/utils.js' %}" as="script" crossorigin="anonymous">
  <link rel="preload" href="{% static 'js/openseadragon-viewer.js' %}" as="script" crossorigin="anonymous">

  <!-- Favicon - Based on "Logo Hunter for Apple Store" from Figma Community -->
  <!-- Original: https://www.figma.com/slides/Pu0Bsm1StbjJn4CLDbXksX/Logo-Hunter-for-Apple-Store--Community- -->
  <!-- Licensed under Creative Commons Attribution 4.0 International (CC BY 4.0) -->
  <!-- License: https://creativecommons.org/licenses/by/4.0/ -->
  <!-- Modifications: Added "Libriscan" text and blue arrow for text extraction meaning -->
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon.png' %}">

  {% htmx_script %}
  <!-- Local Tailwind/daisyUI CSS -->
  <link href="{% static 'css/output.css' %}" rel="stylesheet" type="text/css" />
  
  <!-- OpenSeadragon Dependencies -->
  <script src="{% static 'js/openseadragon/openseadragon.min.js' %}" defer></script>
  
  <!-- Driver.js for Tutorials -->
  <script src="{% static 'js/driver.js/driver.js.iife.js' %}" defer></script>
  <link rel="stylesheet" href="{% static 'css/driver.js/driver.css' %}"/>

  <!-- Application CSS -->
  <link rel="stylesheet" href="{% static 'css/openseadragon-viewer.css' %}">
  <link rel="stylesheet" href="{% static 'css/word_selector.css' %}">
  <link rel="stylesheet" href="{% static 'css/confidence-toggle.css' %}">
  <link rel="stylesheet" href="{% static 'css/word_details.css' %}">
  <link rel="stylesheet" href="{% static 'css/tutorial.css' %}">
  <link rel="stylesheet" href="{% static 'css/search.css' %}">
  
  <!-- Theme Toggle Script -->
  <script>
    // Persist theme selection in localStorage
    function setTheme(theme) {
      const html = document.getElementById('html-root');
      html.setAttribute('data-theme', theme);
      localStorage.setItem('libriscan-theme', theme);
    }

    function toggleTheme() {
      const html = document.getElementById('html-root');
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }

    // On page load, set theme from localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('libriscan-theme');
      if (savedTheme) {
        setTheme(savedTheme);
      }
    });
  </script>
</head>

<body hx-headers='{"x-csrftoken": "{{ csrf_token }}"}' class="min-h-screen bg-base-100 flex flex-col">
  <!-- Navigation -->
  {% include "biblios/components/navigation/navbar.html" %}

  <!-- Main Content -->
  <main id="main-content" class="container mx-auto px-4 flex-grow">
    {% block content %}{% endblock content %}
  </main>

  <!-- Footer -->
  <footer id="app-footer" class="footer footer-center p-4 bg-base-300 text-base-content mt-auto">
    <div>
      <p>Copyright Â© 2025 - All rights reserved by LibriScan</p>
    </div>
  </footer>

  <!-- Application JavaScript -->
  <script src="{% static 'js/svg-loader.js' %}"></script>
  <script src="{% static 'js/utils.js' %}"></script>
  <script src="{% static 'js/openseadragon-viewer.js' %}"></script>
  <script src="{% static 'js/word_selector.js' %}"></script>
  <script src="{% static 'js/confidence-toggle.js' %}"></script>
  <!-- Word details modules - load in dependency order -->
  <script src="{% static 'js/word_details/config.js' %}"></script>
  <script src="{% static 'js/word_details/block_manager.js' %}"></script>
  <script src="{% static 'js/word-review-flag.js' %}"></script>
  <script src="{% static 'js/word_details/update_handler.js' %}"></script>
  <script src="{% static 'js/word_details/navigation.js' %}"></script>
  <script src="{% static 'js/word_details/suggestions.js' %}"></script>
  <script src="{% static 'js/word_details/revert.js' %}"></script>
  <script src="{% static 'js/word_details/editor.js' %}"></script>
  <script src="{% static 'js/word_details/metadata.js' %}"></script>
  <script src="{% static 'js/word_details/keyboard.js' %}"></script>
  <script src="{% static 'js/word_details/audit_history_renderer.js' %}"></script>
  <script src="{% static 'js/word_details/audit_history.js' %}"></script>
  <script src="{% static 'js/word_details/main.js' %}"></script>
  
  <!-- Tutorial System - Load as module for ES6 imports -->
  <script type="module">
    // Set base path for tutorial modules
    window.TUTORIAL_BASE_PATH = '{% static "js/tutorials/" %}';
  </script>
  <script type="module" src="{% static 'js/tutorial.js' %}"></script>
  
  <!-- Page-specific scripts -->
  {% block scripts %}{% endblock %}

  <!-- Floating Help Button (Bug Report + Feature Request + Conditional Tutorials) -->
  <div style="position: fixed; bottom: 5rem; right: 1.5rem; z-index: 50;">
    <div class="dropdown dropdown-top dropdown-end" id="help-button">
      <label tabindex="0" class="btn btn-circle btn-primary btn-lg shadow-2xl hover:shadow-primary/50 transition-all tooltip tooltip-left flex items-center justify-center" data-tip="Help & Resources">
        {% icon 'question-mark-circle' css_class='w-6 h-6' %}
      </label>
      <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-64 p-2 shadow-xl border border-base-300 mb-2">
        
        <!-- Tutorials Section (Conditionally Rendered by Child Templates) -->
        {% block tutorial_section %}
        <!-- No tutorials by default - child templates can override this block -->
        {% endblock %}
        
        <!-- Divider (only show if tutorials exist) -->
        {% block tutorial_divider %}{% endblock %}
        
        <!-- Navigation Tutorial (Available on All Pages) -->
        <li class="menu-title">
          <span class="flex items-center gap-2">
            {% icon 'bars-3' css_class='size-4' %}
            Navigation
          </span>
        </li>
        <li>
          <a id="startNavigationTutorial">
            {% icon 'play' css_class='size-5' %}
            <div class="flex flex-col items-start">
              <span class="font-semibold">Navigation Guide</span>
              <span class="text-xs opacity-70">Learn the navbar</span>
            </div>
          </a>
        </li>
        <div class="divider my-1"></div>
        
        <!-- GitHub Section (Always Visible on All Pages) -->
        <li class="menu-title">
          <span class="flex items-center gap-2">
            {% icon 'exclamation-triangle' css_class='h-4 w-4' stroke_width='2' %}
            Help Us Improve
          </span>
        </li>
        <li>
          <a id="help-bug-report-link" href="https://github.com/Crimson-Vision/Libriscan/issues/new?template=bug_report.yaml" 
             target="_blank" 
             rel="noopener noreferrer"
             class="gap-2">
            {% icon 'info-circle' css_class='h-5 w-5 text-error' stroke_width='2' %}
            <div>
              <div class="font-semibold">Report a Bug</div>
              <div class="text-xs opacity-60">Something not working?</div>
            </div>
          </a>
        </li>
        <li>
          <a id="help-feature-request-link" href="https://github.com/Crimson-Vision/Libriscan/issues/new?template=feature_request.yaml" 
             target="_blank" 
             rel="noopener noreferrer"
             class="gap-2">
            {% icon 'lightbulb' css_class='h-5 w-5 text-info' stroke_width='2' %}
            <div>
              <div class="font-semibold">Request a Feature</div>
              <div class="text-xs opacity-60">Have an idea?</div>
            </div>
          </a>
        </li>
      </ul>
    </div>
  </div>
</body>

</html>