{% load django_htmx %}
{% load static %}
<!doctype html>
<html lang="en-US" data-theme="light" id="html-root">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Libriscan{% endblock %}</title>

  <!-- Favicon - Based on "Logo Hunter for Apple Store" from Figma Community -->
  <!-- Original: https://www.figma.com/slides/Pu0Bsm1StbjJn4CLDbXksX/Logo-Hunter-for-Apple-Store--Community- -->
  <!-- Licensed under Creative Commons Attribution 4.0 International (CC BY 4.0) -->
  <!-- License: https://creativecommons.org/licenses/by/4.0/ -->
  <!-- Modifications: Added "Libriscan" text and blue arrow for text extraction meaning -->
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon.png' %}">

  {% htmx_script %}
  <!-- Local Tailwind/daisyUI CSS -->
  <link href="{% static 'css/output.css' %}" rel="stylesheet" type="text/css" />
  
  <!-- FilePond Dependencies -->
  <link href="{% static 'css/filepond/filepond.css' %}" rel="stylesheet">
  <link href="{% static 'css/filepond/filepond-plugin-image-preview.css' %}" rel="stylesheet">
  <script src="{% static 'js/filepond/filepond-plugin-image-preview.js' %}"></script>
  <script src="{% static 'js/filepond/filepond.js' %}"></script>

  <!-- OpenSeadragon Dependencies -->
  <script src="{% static 'js/openseadragon/openseadragon.min.js' %}"></script>
  
  <!-- Driver.js for Tutorials -->
  <script src="{% static 'js/driver.js/driver.js.iife.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/driver.js/driver.css' %}"/>

  <!-- Application CSS -->
  <link rel="stylesheet" href="{% static 'css/openseadragon-viewer.css' %}">
  <link rel="stylesheet" href="{% static 'css/word_selector.css' %}">
  <link rel="stylesheet" href="{% static 'css/confidence-toggle.css' %}">
  <link rel="stylesheet" href="{% static 'css/word_details.css' %}">
  <link rel="stylesheet" href="{% static 'css/tutorial.css' %}">
  <link rel="stylesheet" href="{% static 'css/search.css' %}">
  
  <!-- Theme Toggle Script -->
  <script>
    // Persist theme selection in localStorage
    function setTheme(theme) {
      const html = document.getElementById('html-root');
      html.setAttribute('data-theme', theme);
      localStorage.setItem('libriscan-theme', theme);
    }

    function toggleTheme() {
      const html = document.getElementById('html-root');
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }

    // On page load, set theme from localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('libriscan-theme');
      if (savedTheme) {
        setTheme(savedTheme);
      }
    });
  </script>
</head>

<body hx-headers='{"x-csrftoken": "{{ csrf_token }}"}' class="min-h-screen bg-base-100 flex flex-col">
  <!-- Navigation -->
  {% include "biblios/components/navigation/navbar.html" %}

  <!-- Main Content -->
  <main id="main-content" class="container mx-auto px-4 flex-grow">
    {% block content %}{% endblock content %}
  </main>

  <!-- Footer -->
  <footer id="app-footer" class="footer footer-center p-4 bg-base-300 text-base-content mt-auto">
    <div>
      <p>Copyright Â© 2025 - All rights reserved by LibriScan</p>
    </div>
  </footer>

  <!-- Application JavaScript -->
  <script src="{% static 'js/svg-loader.js' %}"></script>
  <script src="{% static 'js/utils.js' %}"></script>
  <script src="{% static 'js/openseadragon-viewer.js' %}"></script>
  <script src="{% static 'js/word_selector.js' %}"></script>
  <script src="{% static 'js/confidence-toggle.js' %}"></script>
  <!-- Word details modules - load in dependency order -->
  <script src="{% static 'js/word_details/config.js' %}"></script>
  <script src="{% static 'js/word_details/block_manager.js' %}"></script>
  <script src="{% static 'js/word-review-flag.js' %}"></script>
  <script src="{% static 'js/word_details/update_handler.js' %}"></script>
  <script src="{% static 'js/word_details/navigation.js' %}"></script>
  <script src="{% static 'js/word_details/suggestions.js' %}"></script>
  <script src="{% static 'js/word_details/revert.js' %}"></script>
  <script src="{% static 'js/word_details/editor.js' %}"></script>
  <script src="{% static 'js/word_details/metadata.js' %}"></script>
  <script src="{% static 'js/word_details/keyboard.js' %}"></script>
  <script src="{% static 'js/word_details/audit_history_renderer.js' %}"></script>
  <script src="{% static 'js/word_details/audit_history.js' %}"></script>
  <script src="{% static 'js/word_details/main.js' %}"></script>
  
  <!-- Tutorial System - Load as module for ES6 imports -->
  <script type="module">
    // Set base path for tutorial modules
    window.TUTORIAL_BASE_PATH = '{% static "js/tutorials/" %}';
  </script>
  <script type="module" src="{% static 'js/tutorial.js' %}"></script>
  
  <!-- Page-specific scripts -->
  {% block scripts %}{% endblock %}

  <!-- Floating Help Button (Bug Report + Feature Request + Conditional Tutorials) -->
  <div style="position: fixed; bottom: 5rem; right: 1.5rem; z-index: 50;">
    <div class="dropdown dropdown-top dropdown-end" id="help-button">
      <label tabindex="0" class="btn btn-circle btn-primary btn-lg shadow-2xl hover:shadow-primary/50 transition-all tooltip tooltip-left flex items-center justify-center" data-tip="Help & Resources">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
      </label>
      <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-64 p-2 shadow-xl border border-base-300 mb-2">
        
        <!-- Tutorials Section (Conditionally Rendered by Child Templates) -->
        {% block tutorial_section %}
        <!-- No tutorials by default - child templates can override this block -->
        {% endblock %}
        
        <!-- Divider (only show if tutorials exist) -->
        {% block tutorial_divider %}{% endblock %}
        
        <!-- Navigation Tutorial (Available on All Pages) -->
        <li class="menu-title">
          <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
            Navigation
          </span>
        </li>
        <li>
          <a id="startNavigationTutorial">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
            </svg>
            <div class="flex flex-col items-start">
              <span class="font-semibold">Navigation Guide</span>
              <span class="text-xs opacity-70">Learn the navbar</span>
            </div>
          </a>
        </li>
        <div class="divider my-1"></div>
        
        <!-- GitHub Section (Always Visible on All Pages) -->
        <li class="menu-title">
          <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Help Us Improve
          </span>
        </li>
        <li>
          <a id="help-bug-report-link" href="https://github.com/Crimson-Vision/Libriscan/issues/new?template=bug_report.yaml" 
             target="_blank" 
             rel="noopener noreferrer"
             class="gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <div class="font-semibold">Report a Bug</div>
              <div class="text-xs opacity-60">Something not working?</div>
            </div>
          </a>
        </li>
        <li>
          <a id="help-feature-request-link" href="https://github.com/Crimson-Vision/Libriscan/issues/new?template=feature_request.yaml" 
             target="_blank" 
             rel="noopener noreferrer"
             class="gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <div>
              <div class="font-semibold">Request a Feature</div>
              <div class="text-xs opacity-60">Have an idea?</div>
            </div>
          </a>
        </li>
      </ul>
    </div>
  </div>
</body>

</html>