{% load static %}
<!-- Word Details Component -->

<div id="clickedWordsContainer" class="mt-8 hidden"
     {# Geo coordinates (geo_x_0, geo_y_0, geo_x_1, geo_y_1) removed from data-words-json #}
     data-words-json="{% for word in words %}{{ word.id }},{{ word.text }},{{ word.confidence }},{{ word.confidence_level }},{{ word.line }},{{ word.number }},{{ word.text_type }},{{ word.print_control }},{{ word.extraction_id }},{{ word.suggestions|escapejs }},{{ word.review|yesno:'true,false' }}{% if not forloop.last %};&{% endif %}{% endfor %}"
     data-last-edited-word-id="{{ last_edited_word_id|default:'' }}">
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-0">
      <!-- Word Details Tabs -->
      <div class="relative">
        <div role="tablist" class="tabs tabs-lift">
        <!-- Details Tab -->
        <label class="tab">
          <input type="radio" name="word_details_tabs" id="wordDetailsTab" checked="checked" />
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 sm:me-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
          </svg>
          <span class="hidden sm:inline">Word Details</span>
        </label>
        <div class="tab-content bg-base-100 border-base-300 p-6" id="wordDetailsContent">

          <!-- Word Navigation -->
          <div class="flex justify-between items-center mb-4">
            <button id="prevWordBtn" class="btn btn-outline btn-sm tooltip tooltip-top" data-tip="Previous word" disabled>
              <kbd class="kbd kbd-xs">←</kbd>
              Previous
            </button>
            <span id="wordPosition" class="text-sm opacity-70">0 of 0</span>
            <button id="nextWordBtn" class="btn btn-outline btn-sm tooltip tooltip-top" data-tip="Next word" disabled>
              Next
              <kbd class="kbd kbd-xs">→</kbd>
            </button>
          </div>
          
          <div class="stats shadow-lg overflow-visible w-full mb-4 bg-base-300" id="wordStatsContainer">
            <div class="stat overflow-visible min-w-0 w-full" id="wordStat">
              <div class="flex items-center gap-2 min-w-0 mt-1">
                <div id="clickedWord" class="stat-value text-2xl truncate min-w-0 flex-1 tooltip tooltip-top overflow-hidden text-ellipsis whitespace-nowrap" data-tip="Double-click to edit"></div>
                <input type="text" id="wordInput" class="input input-bordered input-sm hidden min-w-0 flex-1 break-all" style="overflow-wrap: anywhere;" />
                <div class="flex gap-1 flex-shrink-0">
                  <button id="editButton" class="btn btn-ghost btn-sm tooltip tooltip-top flex items-center gap-1" data-tip="Edit word (E)">
                    <kbd class="kbd kbd-xs">E</kbd>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button id="saveButton" class="btn btn-ghost btn-sm hidden tooltip tooltip-top flex items-center gap-1" data-tip="Save (Enter)">
                    <kbd class="kbd kbd-xs">↵</kbd>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  </button>
                  <button id="revertButton" class="btn btn-ghost btn-sm hidden tooltip tooltip-top flex items-center gap-1" data-tip="Cancel (Esc)">
                    <kbd class="kbd kbd-xs">Esc</kbd>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <!-- Word Visibility Control Section -->
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-base-content/70">Word Visibility Control</label>
              <div class="dropdown w-full">
                <div tabindex="0" role="button" class="btn btn-sm btn-outline w-full justify-between normal-case h-9 min-h-9" id="wordVisibilityControlDropdownBtn">
                  <div class="flex items-center gap-2">
                    <span id="wordVisibilityControlBadge" class="badge badge-sm">Include</span>
                  </div>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[100] w-full p-2 shadow-xl border border-base-300">
                  <li><a data-value="I" class="word-visibility-control-option">
                    <span class="badge badge-success badge-sm">Include</span>
                  </a></li>
                  <li><a data-value="M" class="word-visibility-control-option">
                    <span class="badge badge-warning badge-sm">Merge with Prior</span>
                  </a></li>
                  <li><a data-value="O" class="word-visibility-control-option">
                    <span class="badge badge-error badge-sm">Omit</span>
                  </a></li>
                </ul>
              </div>
            </div>
            
            <!-- Confidence Level Section -->
            <div class="flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-base-content/70">Confidence Level</label>
                <span id="confidenceLevel" class="badge badge-sm"></span>
              </div>
              <button id="acceptBtn" class="btn btn-sm btn-primary w-full hidden gap-1.5 tooltip tooltip-top" data-tip="Accept (A)">
                <span class="text-xs">Accept</span>
                <kbd class="kbd kbd-xs">A</kbd>
              </button>
            </div>
          </div>
          
          <div class="stats shadow w-full">
            <div class="stat">
              <div class="stat-title mb-2 flex items-center gap-2">
                Suggestions
                <span class="badge badge-ghost badge-xs tooltip tooltip-right" data-tip="Press 1-9 to apply suggestions quickly">
                  <kbd class="kbd kbd-xs">1-9</kbd>
                </span>
              </div>
              <div id="wordSuggestions" class="stat-desc p-0">
                <!-- Suggestions will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Audit History Tab -->
        <label class="tab">
          <input type="radio" name="word_details_tabs" id="wordAuditHistoryTab" />
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 sm:me-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <span class="hidden sm:inline">Audit History</span>
        </label>
        <div class="tab-content bg-base-100 border-base-300 p-6" id="wordAuditHistoryContent">
          {% include 'biblios/components/forms/audit_history_timeline.html' %}
        </div>
      </div>

      <!-- Actions Dropdown Container with Review Flag -->
        <div class="absolute top-2 right-4 z-10 flex items-center gap-2">
          <!-- Review Flag Button -->
          <div id="reviewFlagContainer">
            <button id="reviewFlagBtn" class="btn btn-ghost btn-sm tooltip tooltip-left opacity-70 hover:opacity-100 transition-opacity duration-200" data-tip="Raise for Review" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="rgb(249, 115, 22)" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
              </svg>
            </button>
          </div>

          <!-- Actions Dropdown -->
          <div id="wordActionsDropdownContainer" class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-sm opacity-70 hover:opacity-100 transition-opacity duration-200" id="wordActionsDropdown">
              <!-- Kebab icon -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
              </svg>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow border border-base-200">
              <li>
                <a id="revertToOriginalAction" class="opacity-50 pointer-events-none" aria-disabled="true" tabindex="-1">Revert to Original</a>
              </li>
              <li>
                <a id="saveToDictionaryAction" class="opacity-50 pointer-events-none" aria-disabled="true" tabindex="-1">Save to Dictionary</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Revert to Original Confirmation Modal -->
<dialog id="revertConfirmationModal" class="modal">
  <div class="modal-box">
    <div class="flex items-center gap-3 mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-warning">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
      </svg>
      <h3 class="font-bold text-lg">Confirm Revert to Original</h3>
    </div>
    <p class="py-2">
      Are you sure you want to revert this word to its original value?
    </p>
    <div class="alert alert-warning mt-4">
      <span class="text-sm font-semibold">This action cannot be undone.</span>
    </div>
    <p class="text-sm text-base-content/70 mt-4">
      All current changes will be permanently lost.
    </p>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost" value="cancel">Cancel</button>
        <button class="btn btn-error" value="confirm">Revert to Original</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
