{% load static %}
{% load icon_tags %}
<!-- Word Details Component -->

<div id="clickedWordsContainer" class="mt-8 hidden"
     {# Geo coordinates (geo_x_0, geo_y_0, geo_x_1, geo_y_1) removed from data-words-json #}
     data-words-json="{% for word in words %}{{ word.id }},{{ word.text }},{{ word.confidence }},{{ word.confidence_level }},{{ word.line }},{{ word.number }},{{ word.text_type }},{{ word.print_control }},{{ word.suggestions|escapejs }},{{ word.review|yesno:'true,false' }}{% if not forloop.last %};&{% endif %}{% endfor %}"
     data-last-edited-word-id="{{ last_edited_word_id|default:'' }}">
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body p-0">
      <!-- Word Details Tabs -->
      <div class="relative">
        <div role="tablist" class="tabs tabs-lift">
        <!-- Details Tab -->
        <label id="word-details-tab-label" class="tab">
          <input type="radio" name="word_details_tabs" id="wordDetailsTab" checked="checked" />
          {% icon 'information-circle' css_class='size-4 sm:me-2' %}
          <span class="hidden sm:inline">Word Details</span>
        </label>
        <div class="tab-content bg-base-100 border-base-300 p-6" id="wordDetailsContent">

          <!-- Word Navigation -->
          <div class="flex justify-between items-center mb-4">
            <button id="prevWordBtn" class="btn btn-outline btn-sm tooltip tooltip-top" data-tip="Previous word" disabled>
              <kbd class="kbd kbd-xs">←</kbd>
              Previous
            </button>
            <span id="wordPosition" class="text-sm opacity-70">0 of 0</span>
            <button id="nextWordBtn" class="btn btn-outline btn-sm tooltip tooltip-top" data-tip="Next word" disabled>
              Next
              <kbd class="kbd kbd-xs">→</kbd>
            </button>
          </div>
          
          <div class="stats shadow-lg overflow-visible w-full mb-4 bg-base-300" id="wordStatsContainer">
            <div class="stat overflow-visible min-w-0 w-full" id="wordStat">
              <div class="flex items-center gap-2 min-w-0 mt-1">
                <div id="clickedWord" class="stat-value text-2xl truncate min-w-0 flex-1 tooltip tooltip-top overflow-hidden text-ellipsis whitespace-nowrap" data-tip="Double-click to edit"></div>
                <input type="text" id="wordInput" class="input input-bordered input-sm hidden min-w-0 flex-1 break-all" style="overflow-wrap: anywhere;" />
                <div class="flex gap-1 flex-shrink-0">
                  <button id="editButton" class="btn btn-ghost btn-sm tooltip tooltip-top flex items-center gap-1" data-tip="Edit word (E)">
                    <kbd class="kbd kbd-xs">E</kbd>
                    {% icon 'edit' css_class='size-4' %}
                  </button>
                  <button id="saveButton" class="btn btn-ghost btn-sm hidden tooltip tooltip-top flex items-center gap-1" data-tip="Save (Enter)">
                    <kbd class="kbd kbd-xs">↵</kbd>
                    {% icon 'check-circle' css_class='size-4' %}
                  </button>
                  <button id="revertButton" class="btn btn-ghost btn-sm hidden tooltip tooltip-top flex items-center gap-1" data-tip="Cancel (Esc)">
                    <kbd class="kbd kbd-xs">Esc</kbd>
                    {% icon 'x-mark' css_class='size-4' %}
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <!-- Word Visibility Control Section -->
            <div class="flex flex-col gap-2">
              <label class="text-sm font-medium text-base-content/70">Word Visibility Control</label>
              <div class="dropdown w-full">
                <div tabindex="0" role="button" class="btn btn-sm btn-outline w-full justify-between normal-case h-9 min-h-9" id="wordVisibilityControlDropdownBtn">
                  <div class="flex items-center gap-2">
                    <span id="wordVisibilityControlBadge" class="badge badge-sm">Include</span>
                  </div>
                  {% icon 'chevron-down' css_class='h-4 w-4 shrink-0' stroke_width='2' %}
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[100] w-full p-2 shadow-xl border border-base-300">
                  <li><a data-value="I" class="word-visibility-control-option">
                    <span class="badge badge-success badge-sm">Include</span>
                  </a></li>
                  <li><a data-value="M" class="word-visibility-control-option">
                    <span class="badge badge-warning badge-sm">Merge with Prior</span>
                  </a></li>
                  <li><a data-value="O" class="word-visibility-control-option">
                    <span class="badge badge-error badge-sm">Omit</span>
                  </a></li>
                </ul>
              </div>
            </div>
            
            <!-- Confidence Level Section -->
            <div class="flex flex-col gap-2" id="confidenceLevelSection">
              <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-base-content/70">Confidence Level</label>
                <span id="confidenceLevel" class="badge badge-sm"></span>
              </div>
              <button id="acceptBtn" class="btn btn-sm btn-primary w-full hidden gap-1.5 tooltip tooltip-top" data-tip="Accept (A)">
                <span class="text-xs">Accept</span>
                <kbd class="kbd kbd-xs">A</kbd>
              </button>
            </div>
          </div>
          
          <div id="word-suggestions-stats" class="stats shadow w-full">
            <div id="word-suggestions-stat" class="stat">
              <div id="word-suggestions-title" class="stat-title mb-2 flex items-center gap-2">
                Suggestions
                <span id="word-suggestions-shortcut-badge" class="badge badge-ghost badge-xs tooltip tooltip-right" data-tip="Press 1-9 to apply suggestions quickly">
                  <kbd class="kbd kbd-xs">1-9</kbd>
                </span>
              </div>
              <div id="wordSuggestions" class="stat-desc p-0">
                <!-- Suggestions will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Audit History Tab -->
        <label id="word-audit-history-tab-label" class="tab">
          <input type="radio" name="word_details_tabs" id="wordAuditHistoryTab" />
          {% icon 'clock' css_class='size-4 sm:me-2' %}
          <span class="hidden sm:inline">Audit History</span>
        </label>
        <div class="tab-content bg-base-100 border-base-300 p-6" id="wordAuditHistoryContent">
          {% include 'biblios/components/forms/audit_history_timeline.html' %}
        </div>
      </div>

      <!-- Actions Dropdown Container with Review Flag -->
        <div class="absolute top-2 right-4 z-10 flex items-center gap-2">
          <!-- Review Flag Button -->
          <div id="reviewFlagContainer">
            <button id="reviewFlagBtn" class="btn btn-ghost btn-sm tooltip tooltip-left opacity-70 hover:opacity-100 transition-opacity duration-200" data-tip="Raise for Review" disabled>
              {% icon 'flag-outline' css_class='size-6' stroke='rgb(249, 115, 22)' %}
            </button>
          </div>

          <!-- Actions Dropdown -->
          <div id="wordActionsDropdownContainer" class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-sm opacity-70 hover:opacity-100 transition-opacity duration-200" id="wordActionsDropdown">
              {% icon 'ellipsis-vertical' css_class='size-6' id='wordActionsDropdownIcon' %}
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow border border-base-200">
              <li>
                <a id="revertToOriginalAction" class="opacity-50 pointer-events-none" aria-disabled="true" tabindex="-1">Revert to Original</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Revert to Original Confirmation Modal -->
<dialog id="revertConfirmationModal" class="modal">
  <div id="revert-modal-box" class="modal-box">
    <div id="revert-modal-header" class="flex items-center gap-3 mb-4">
      {% icon 'triangle-exclamation' css_class='size-6 text-warning' %}
      <h3 id="revert-modal-title" class="font-bold text-lg">Confirm Revert to Original</h3>
    </div>
    <p id="revert-modal-message" class="py-2">
      Are you sure you want to revert this word to its original value?
    </p>
    <div id="revert-modal-warning" class="alert alert-warning mt-4">
      <span class="text-sm font-semibold">This action cannot be undone.</span>
    </div>
    <p id="revert-modal-sub-message" class="text-sm text-base-content/70 mt-4">
      All current changes will be permanently lost.
    </p>
    <div id="revert-modal-actions" class="modal-action">
      <form method="dialog">
        <button id="revert-modal-cancel-btn" class="btn btn-ghost" value="cancel">Cancel</button>
        <button id="revert-modal-confirm-btn" class="btn btn-error" value="confirm">Revert to Original</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
