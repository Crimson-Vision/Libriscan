{% load icon_tags %}
<!-- Formatted Text Display Component
   - Displays formatted text from either 'formatted_text' variable or reconstructed from 'words'
   - Excludes words with print_control = 'O' (Omit) or 'M' (Merge)
   - Only includes words with print_control = 'I' (Include)
   - Includes copy functionality via LibriscanUtils.initCopyButtons() from utils.js 
   - Auto-refreshes when words are updated via event
-->

<div id="formattedTextContainer" class="prose relative">
  <div class="h-[100vh] overflow-y-auto p-4">
    {% if formatted_text %}
      <button type="button" class="btn btn-ghost btn-sm absolute top-2 right-2 copy-formatted-btn" title="Copy formatted text" aria-label="Copy formatted text" aria-pressed="false">
        {% icon 'clipboard-document' css_class='size-6' %}
        <span class="ms-2">Copy</span>
      </button>
      <div class="{{ height_class }} overflow-y-auto p-4 formatted-text-content">
        <p>{{ formatted_text }}</p>
      </div>
    {% elif words %}
      <button type="button" class="btn btn-ghost btn-sm absolute top-2 right-2 copy-formatted-btn" title="Copy formatted text" aria-label="Copy formatted text" aria-pressed="false">
        {% icon 'clipboard-document' css_class='size-6' %}
        <span class="ms-2">Copy</span>
      </button>
      <div class="{{ height_class }} overflow-y-auto p-4 formatted-text-content">
        <p>
          {% for w in words %}{% if w.print_control == 'I' %}{{ w.text }}{% if not forloop.last %} {% endif %}{% endif %}{% endfor %}
        </p>
      </div>
    {% else %}
      <p class="text-base-content/60">No formatted text available.</p>
    {% endif %}
  </div>
</div>

<script>
(function() {
  // Constants for word visibility control values
  const PRINT_CONTROL = {
    INCLUDE: 'I',
    MERGE: 'M',
    OMIT: 'O'
  };

  let isStale = false;
  
  // Mark formatted text as stale when words are updated
  document.addEventListener('wordUpdated', () => isStale = true);
  document.addEventListener('wordVisibilityControlUpdated', () => isStale = true);
  
  /**
   * Refreshes the formatted text display
   * Excludes words with print_control = 'O' (Omit) or 'M' (Merge)
   * Only includes words with print_control = 'I' (Include)
   */
  function refreshFormattedText() {
    if (!isStale) return;
    
    const contentEl = document.querySelector('.formatted-text-content p');
    const wordBlocks = document.querySelectorAll('.word-block');
    if (!contentEl || !wordBlocks.length) return;
    
    // Filter out omitted and merged words, only include words with print_control = 'I'
    const text = Array.from(wordBlocks)
      .filter(block => block.dataset.wordPrintControl === PRINT_CONTROL.INCLUDE)
      .map(block => block.dataset.wordText)
      .join(' ');
    
    contentEl.textContent = text;
    isStale = false;
  }
  
  // Refresh formatted text when tab is switched
  document.querySelectorAll('input[name="text_tabs"]').forEach(radio => {
    radio.addEventListener('change', function() {
      if (!this.checked) return;
      const tabContent = this.closest('label').nextElementSibling;
      if (tabContent?.contains(document.getElementById('formattedTextContainer'))) {
        refreshFormattedText();
      }
    });
  });
})();
</script>
