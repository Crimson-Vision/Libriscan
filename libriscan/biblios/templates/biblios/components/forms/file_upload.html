{% load static %}

<style>
/* Prevent drag events outside upload area */
body * {
  pointer-events: auto;
}

/* Remove blocking credits */
/* https://pqina.nl/filepond/docs/api/instance/properties/#disabling-credits */
.filepond--credits {
  display: none !important;
}

.upload-area {
  pointer-events: none;
}

.upload-area .filepond--root,
.upload-area .border-2 {
  pointer-events: auto;
}
</style>

<div class="card bg-base-100 shadow-sm h-full">
  <div class="card-body">
    <h2 class="card-title text-2xl mb-6">Quick Text Recognition</h2>
    
    <!-- File Upload Area -->
    <div class="upload-area w-full">
      <!-- FilePond Input -->
      <input type="file" 
             class="filepond"
             name="image"
             accept="image/tiff,image/jpeg,image/png"
             data-max-file-size="5MB">

      <!-- Identifier Input -->
      <div class="form-control mt-4">
        <label class="label">
          <span class="label-text font-semibold">Identifier</span>
        </label>
        <input type="text" 
               id="identifierInput" 
               name="identifier" 
               class="input input-bordered w-full" 
               placeholder="Enter identifier (no spaces)"
               disabled
               pattern="[^\s]+"
               title="Identifier cannot contain whitespace">
        <label class="label">
          <span class="label-text-alt">Identifier cannot contain whitespace</span>
        </label>
      </div>

             <!-- Upload and Analyze Buttons Side by Side -->
             <div class="flex gap-2 mt-4 w-full">
               <button id="uploadBtn" 
                 class="btn btn-primary flex-1 flex items-center gap-2"
                 disabled>
                 <span id="uploadBtnText">Upload</span>
                 <span id="uploadSpinner" class="loading loading-bars loading-sm hidden"></span>
               </button>
               <button id="extractBtn" class="btn btn-accent flex-1 flex items-center gap-2" disabled>
                 <span id="extractBtnText">Extract</span>
                 <span id="extractSpinner" class="loading loading-bars loading-sm hidden"></span>
               </button>
             </div>
    </div>
  </div>
</div>

<!-- Drag Drop Prevention Script -->
<script>
  // Prevent default drag behavior outside upload area
  document.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
  }, false);

  document.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
  }, false);
</script>

<!-- FilePond Initialization -->
<script>
  // Register the image preview plugin
  FilePond.registerPlugin(FilePondPluginImagePreview);

  // Get the input element
  const inputElement = document.querySelector('input[type="file"].filepond');

  // Create the FilePond instance
  const pond = FilePond.create(inputElement, {
    // Disable automatic upload
    instantUpload: false,

  // File validation using Django settings
    acceptedFileTypes: ['image/tiff', 'image/jpeg', 'image/png'],
    maxFileSize: '5MB',

    // Style settings
    styleButtonRemoveItemPosition: 'right',
    stylePanelLayout: 'integrated',
    styleLoadIndicatorPosition: 'center',
    styleProgressIndicatorPosition: 'center',
    styleButtonProcessItemPosition: 'center',
    stylePanelAspectRatio: 1.25,
    
    // Image preview settings
    allowImagePreview: true,
    imageCropAspectRatio: '1:1',
    
    server: {
      process: {
        url: "{% url 'handle_upload' %}",
        headers: {
          'X-CSRFToken': LibriscanUtils.getCSRFToken()
        }
      }
    },

    onaddfile: (error, file) => {
      if (error) {
        console.error('File addition error:', error.body || error.message);
        return;
      }
      document.getElementById('uploadBtn').disabled = false;
      
      // Enable identifier input and pre-populate with filename (without extension)
      const identifierInput = document.getElementById('identifierInput');
      if (identifierInput) {
        identifierInput.disabled = false;
        const filename = file.filename || file.name || '';
        // Remove extension and replace all whitespace (spaces, tabs, etc.) with underscores
        const nameWithoutExt = filename.replace(/\.[^/.]+$/, '').replace(/\s+/g, '_');
        identifierInput.value = nameWithoutExt;
      }
    },
    onprocessfile: (error, file) => {
      const btn = document.getElementById('uploadBtn');
      const spinner = document.getElementById('uploadSpinner');
      const btnText = document.getElementById('uploadBtnText');

      // Hide loading state
      spinner.classList.add('hidden');
      btnText.textContent = 'Upload';
      
      if (error) {
        console.error('Upload error:', error);
        // Disable identifier input on error
        const identifierInput = document.getElementById('identifierInput');
        if (identifierInput) {
          identifierInput.disabled = true;
        }
      } else {
        // Keep identifier input enabled after successful upload
      }
      // Disable upload button after processing
      btn.disabled = true;
    }
  });

  // Handle upload button click
  document.getElementById('uploadBtn').addEventListener('click', () => {
    const btn = document.getElementById('uploadBtn');
    const spinner = document.getElementById('uploadSpinner');
    const btnText = document.getElementById('uploadBtnText');
    const identifierInput = document.getElementById('identifierInput');
    
    // Validate identifier before upload
    if (identifierInput && identifierInput.value.trim() && /\s/.test(identifierInput.value)) {
      alert('Identifier cannot contain whitespace');
      return;
    }
    
    // Show loading state
    btn.disabled = true;
    spinner.classList.remove('hidden');
    btnText.textContent = 'Uploading...';
    
    pond.processFiles();
  });
  
  // Validate identifier input on change (remove whitespace)
  const identifierInput = document.getElementById('identifierInput');
  if (identifierInput) {
    identifierInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\s/g, '');
    });
  }

  // Enable Analyze button after upload
  pond.on('processfile', (error, file) => {
    if (!error) {
      document.getElementById('extractBtn').disabled = false;
    }
  });

  // Handle Extract button click
  document.getElementById('extractBtn').addEventListener('click', function() {
    const btn = this;
    const spinner = document.getElementById('extractSpinner');
    const btnText = document.getElementById('extractBtnText');

    // Show loading state
    btn.disabled = true;
    spinner.classList.remove('hidden');
    btnText.textContent = 'Extracting...';
    
    // Simulate extraction process
    setTimeout(function() {
      // Hide extract button spinner
      spinner.classList.add('hidden');
      btnText.textContent = 'Extract';
      btn.disabled = false;
      
      // Hide right column temporarily
      document.getElementById('rightColumn').style.display = 'none';
      
      // After a brief pause, show loading animation
      setTimeout(function() {
        document.getElementById('rightColumn').style.display = '';
        document.getElementById('extractPrompt').style.display = 'none';
        const loadingContainer = document.getElementById('loadingContainer');
        loadingContainer.style.display = '';
      }, 300); // Short delay for smooth transition

      // After a delay, hide loading and show text display
      setTimeout(function() {
        loadingContainer.style.display = 'none';
        const textDisplayContainer = document.getElementById('textDisplayContainer');
        textDisplayContainer.style.display = '';
        textDisplayContainer.scrollIntoView({ behavior: 'smooth' });
      }, 1500); // Show loading animation for 1.5 seconds
    }, 2000);
  });
</script>
