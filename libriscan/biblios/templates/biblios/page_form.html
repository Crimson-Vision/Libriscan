{% extends "biblios/base.html" %}

{% block title %}Upload Page Â· Libriscan{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-base-200 to-base-300 py-12 px-4">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">Upload Page</h1>
            <p class="text-base-content/70">Add a new page to your document</p>
        </div>

        <div class="card bg-base-100 shadow-2xl">
            <div class="card-body">
                <form enctype="multipart/form-data" method="post">
                    {% csrf_token %}
                    <div class="space-y-6">
                        {% for field in form.visible_fields %}
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">{{ field.label }}</span>
                            </label>
                            
                            {% if field.field.widget.input_type == "number" %}
                                <input type="number" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    class="input input-bordered input-lg w-full" value="{{ field.value|default_if_none:'' }}" 
                                    placeholder="Enter page number" {% if field.field.required %}required{% endif %}>
                            
                            {% elif field.field.widget.input_type == "file" %}
                                <input type="file" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    accept=".jpeg,.jpg,.png,image/jpeg,image/png" 
                                    class="file-input file-input-bordered file-input-primary file-input-lg w-full" 
                                    {% if field.field.required %}required{% endif %}>
                                
                                <div id="fileError" class="alert alert-error mt-2 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span></span>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt">Please provide a JPG or PNG image with a maximum size of {{ max_upload_size|filesizeformat }}</span>
                                </label>
                            {% elif field.name == "identifier" %}
                                <input type="text" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    class="input input-bordered input-lg w-full" 
                                    value="{{ field.value|default_if_none:'' }}" 
                                    placeholder="Enter identifier (no spaces)"
                                    disabled
                                    pattern="[^\s]+"
                                    title="Identifier cannot contain whitespace">
                                <label class="label">
                                    <span class="label-text-alt">Identifier cannot contain whitespace</span>
                                </label>
                            {% else %}
                                {{ field }}
                            {% endif %}
                            
                            {% if field.help_text %}
                                <label class="label"><span class="label-text-alt">{{ field.help_text }}</span></label>
                            {% endif %}
                            
                            {% for error in field.errors %}
                            <div class="alert alert-error mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>{{ error }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="submit" id="submitBtn" class="btn btn-primary btn-lg w-full mt-8" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Upload Page
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.querySelector('input[type="file"]');
        const identifierInput = document.querySelector('input[name="identifier"]');
        const submitBtn = document.querySelector('#submitBtn');
        
        LibriscanUtils.setupFileValidation(
            'input[type="file"]',
            '#submitBtn',
            '#fileError',
            {
                maxSize: {{ max_upload_size|default:5242880 }},
                allowedTypes: {{ allowed_upload_types|default:'["image/jpeg", "image/png"]'|safe }},
                allowedExtensions: [".jpg", ".jpeg", ".png"]
            }
        );
        
        // Enable identifier input when file is valid (button enabled)
        const checkFileValid = () => {
            if (identifierInput && fileInput && fileInput.files[0]) {
                const isValid = !submitBtn.disabled;
                identifierInput.disabled = !isValid;
                if (isValid && !identifierInput.value) {
                    // Remove extension and replace all whitespace (spaces, tabs, etc.) with underscores
                    const filename = fileInput.files[0].name.replace(/\.[^/.]+$/, '').replace(/\s+/g, '_');
                    identifierInput.value = filename;
                }
            }
        };
        
        fileInput.addEventListener('change', () => {
            setTimeout(checkFileValid, 100);
        });
        
        // Watch for button state changes
        const observer = new MutationObserver(checkFileValid);
        if (submitBtn) {
            observer.observe(submitBtn, { attributes: true, attributeFilter: ['disabled'] });
        }
        
        // Remove whitespace from identifier input
        if (identifierInput) {
            identifierInput.addEventListener('input', (event) => {
                event.target.value = event.target.value.replace(/\s/g, '');
            });
        }
    });
</script>
{% endblock %}