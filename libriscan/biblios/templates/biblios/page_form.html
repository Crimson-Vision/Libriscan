{% extends "biblios/base.html" %}
{% load static %}

{% block tutorial_section %}
<!-- Tutorials Section - Only on Page Form View -->
<li class="menu-title">
  <span class="flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
    </svg>
    Tutorials
  </span>
</li>
<li>
  <a id="startPageFormTutorial" class="active">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
    </svg>
    <div class="flex flex-col items-start">
      <span class="font-semibold">Page Upload Guide</span>
      <span class="text-xs opacity-70">Learn the basics</span>
    </div>
  </a>
</li>
{% endblock %}

{% block tutorial_divider %}
<div class="divider my-1"></div>
{% endblock %}

{% block title %}Upload Page Â· Libriscan{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-base-200 to-base-300 py-12 px-4">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8" id="pageUploadHeader">
            <h1 class="text-4xl font-bold mb-2" id="pageUploadTitle">Upload Page</h1>
            <p class="text-base-content/70">Add a new page to your document</p>
        </div>

        <div class="card bg-base-100 shadow-2xl" id="pageUploadCard">
            <div class="card-body">
                <form enctype="multipart/form-data" method="post" id="pageUploadForm">
                    {% csrf_token %}
                    <div class="space-y-6" id="pageUploadFields">
                        {% for field in form.visible_fields %}
                        <div class="form-control" id="pageField_{{ field.name }}">
                            <label class="label">
                                <span class="label-text font-semibold">{{ field.label }}</span>
                            </label>
                            
                            {% if field.field.widget.input_type == "number" %}
                                <input type="number" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    class="input input-bordered input-lg w-full" value="{{ field.value|default_if_none:'' }}" 
                                    placeholder="Enter page number" {% if field.field.required %}required{% endif %}>
                            
                            {% elif field.field.widget.input_type == "file" %}
                                <input type="file" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    accept=".jpeg,.jpg,.png,image/jpeg,image/png" 
                                    class="file-input file-input-bordered file-input-primary file-input-lg w-full" 
                                    {% if field.field.required %}required{% endif %}>
                                
                                <div id="fileError" class="alert alert-error mt-2 hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span></span>
                                </div>
                                <label class="label">
                                    <span class="label-text-alt">Please provide a JPG or PNG image with a maximum size of {{ max_upload_size|filesizeformat }}</span>
                                </label>
                            {% elif field.name == "identifier" %}
                                <input type="text" name="{{ field.html_name }}" id="{{ field.id_for_label }}" 
                                    class="input input-bordered input-lg w-full" 
                                    value="{{ field.value|default_if_none:'' }}" 
                                    placeholder="Enter identifier (no spaces)"
                                    disabled
                                    pattern="[^\s]+"
                                    title="Identifier cannot contain whitespace">
                                <label class="label">
                                    <span class="label-text-alt">Identifier cannot contain whitespace</span>
                                </label>
                            {% else %}
                                {{ field }}
                            {% endif %}
                            
                            {% if field.help_text %}
                                <label class="label"><span class="label-text-alt">{{ field.help_text }}</span></label>
                            {% endif %}
                            
                            {% for error in field.errors %}
                            <div class="alert alert-error mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>{{ error }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="submit" id="submitBtn" class="btn btn-primary btn-lg w-full mt-8" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Upload Page
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.querySelector('input[type="file"]');
        const identifierInput = document.querySelector('input[name="identifier"]');
        const submitBtn = document.querySelector('#submitBtn');
        
        LibriscanUtils.setupFileValidation(
            'input[type="file"]',
            '#submitBtn',
            '#fileError',
            {
                maxSize: {{ max_upload_size|default:5242880 }},
                allowedTypes: {{ allowed_upload_types|default:'["image/jpeg", "image/png"]'|safe }},
                allowedExtensions: [".jpg", ".jpeg", ".png"]
            }
        );
        
        // Enable identifier input when file is valid (button enabled)
        const checkFileValid = () => {
            if (identifierInput && fileInput && fileInput.files[0]) {
                const isValid = !submitBtn.disabled;
                identifierInput.disabled = !isValid;
                if (isValid && !identifierInput.value) {
                    // Remove extension and replace all whitespace (spaces, tabs, etc.) with underscores
                    const filename = fileInput.files[0].name.replace(/\.[^/.]+$/, '').replace(/\s+/g, '_');
                    identifierInput.value = filename;
                }
            }
        };
        
        fileInput.addEventListener('change', () => {
            setTimeout(checkFileValid, 100);
        });
        
        // Watch for button state changes
        const observer = new MutationObserver(checkFileValid);
        if (submitBtn) {
            observer.observe(submitBtn, { attributes: true, attributeFilter: ['disabled'] });
        }
        
        // Remove whitespace from identifier input
        if (identifierInput) {
            identifierInput.addEventListener('input', (event) => {
                event.target.value = event.target.value.replace(/\s/g, '');
            });
        }
    });
</script>
{% endblock %}